local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local parentGui = (gethui and gethui()) or game:GetService("CoreGui")
local HUB_KEY = "hub_live_6812bd621eb9953eee0b5421ad25db77c7fcd9aea475bceb"
local GuiService = game:GetService("GuiService")
local CoreGui = game:GetService("CoreGui")
local SAVE_DIR = "AFKTY"
local SAVE_FILE = "AFKTY/token.txt"
local CONFIG_FILE = "AFKTY/config.json"
local Config = {
	JOIN_ACTIVE = false,
	LEAVE_ACTIVE = false,
	CHAT_ACTIVE = false,
	REEXEC_ENABLED = false
}
local function saveConfig()
	if not writefile then return end
	if makefolder then
		pcall(function() makefolder(SAVE_DIR) end)
	end
	local HttpService = game:GetService("HttpService")
	local json = HttpService:JSONEncode(Config)
	pcall(function() writefile(CONFIG_FILE, json) end)
end
local function loadConfig()
	if not readfile then return end
	local ok, content
	if isfile then
		if not isfile(CONFIG_FILE) then return end
		ok, content = pcall(function() return readfile(CONFIG_FILE) end)
	else
		ok, content = pcall(function() return readfile(CONFIG_FILE) end)
		if not ok then return end
	end
	if not ok or not content or content == "" then return end
	local HttpService = game:GetService("HttpService")
	local ok2, data = pcall(function() return HttpService:JSONDecode(content) end)
	if ok2 and type(data) == "table" then
		for k, v in pairs(data) do
			if Config[k] ~= nil then
				Config[k] = v
			end
		end
	end
end

loadConfig()

local function getQueue()
	return (syn and syn.queue_on_teleport) or _G.queue_on_teleport or queue_on_teleport or queueteleport or queue_teleport
end
do
	if type(getgenv) == "function" then
		local g = getgenv()
		if g.AFKTY_REEXEC_ENABLED == nil then g.AFKTY_REEXEC_ENABLED = false end
		if g.AFKTY_JOIN_ACTIVE == nil then g.AFKTY_JOIN_ACTIVE = false end
		if g.AFKTY_LEAVE_ACTIVE == nil then g.AFKTY_LEAVE_ACTIVE = false end
		if g.AFKTY_CHAT_ACTIVE == nil then g.AFKTY_CHAT_ACTIVE = false end
		g.AFKTY_CONNECTED = false
	end
end
local function TryLoadSDK()
	if type(loadstring) ~= "function" then
		return nil, "loadstring unavailable"
	end
	local url = "https://raw.githubusercontent.com/alphavalto-svg/AFKTY/refs/heads/main/AFTKYStandalone"
	local okBody, body = pcall(function() return game:HttpGet(url) end)
	if not okBody or type(body) ~= "string" or #body == 0 then
		return nil, "failed to fetch SDK"
	end
	local lf = loadstring(body)
	if not lf then
		return nil, "failed to compile SDK"
	end
	local okRun, res = pcall(lf)
	if okRun and res ~= nil then
		return res, nil
	end
	return nil, tostring(res)
end
local AFKTY = nil
local function trim(s)
	return (s:gsub("^%s+", ""):gsub("%s+$", ""))
end
local connecting = false
local SAVE_DIR = "AFKTY"
local SAVE_FILE = "AFKTY/token.txt"
local reexecQueued = false
local function getSavedToken()
	local tok = ""
	if isfile and readfile and isfile(SAVE_FILE) then
		local ok, val = pcall(function() return readfile(SAVE_FILE) end)
		if ok and type(val)=="string" then
			tok = (val:gsub("^%s+",""):gsub("%s+$","")):upper()
		end
	end
	if tok == "" and type(getgenv)=="function" then
		local g = getgenv()
		if g and type(g.AFKTY_SAVED_TOKEN)=="string" then
			tok = (g.AFKTY_SAVED_TOKEN:gsub("^%s+",""):gsub("%s+$","")):upper()
		end
	end
	return tok
end
local function queueReexec()
	if not (Config and Config.REEXEC_ENABLED) then return end
	if reexecQueued then return end
	local q = getQueue()
	if not q then
		return
	end
	local embedToken = getSavedToken()
	local code = ([=[
if not game:IsLoaded() then game.Loaded:Wait() end
repeat task.wait() until game:GetService("Players").LocalPlayer
task.wait(1)
local g = (getgenv and getgenv()) or {}
g.AFKTY_HUB_KEY = "]=] .. HUB_KEY .. [=["
g.AFKTY_SKIP_AUTOCONNECT = true
g.AFKTY_SAVED_TOKEN = "]=] .. embedToken .. [=["

-- Load config from file
local Config = {
	JOIN_ACTIVE = false,
	LEAVE_ACTIVE = false,
	CHAT_ACTIVE = false,
	REEXEC_ENABLED = true
}
pcall(function()
	if readfile and isfile and isfile("AFKTY/config.json") then
		local content = readfile("AFKTY/config.json")
		if content and content ~= "" then
			local HttpService = game:GetService("HttpService")
			local data = HttpService:JSONDecode(content)
			if type(data) == "table" then
				for k, v in pairs(data) do
					if Config[k] ~= nil then
						Config[k] = v
					end
				end
			end
		end
	end
end)
-- Sync to getgenv
g.AFKTY_JOIN_ACTIVE = Config.JOIN_ACTIVE
g.AFKTY_LEAVE_ACTIVE = Config.LEAVE_ACTIVE
g.AFKTY_CHAT_ACTIVE = Config.CHAT_ACTIVE
g.AFKTY_REEXEC_ENABLED = Config.REEXEC_ENABLED

local token = ""
if isfile and readfile and isfile("AFKTY/token.txt") then
	local ok, val = pcall(function() return readfile("AFKTY/token.txt") end)
	if ok and type(val)=="string" then token = (val:gsub("^%s+",""):gsub("%s+$","")):upper() end
end
if token == "" then
	token = g.AFKTY_SAVED_TOKEN or ""
end
local okBody, body = pcall(function() return game:HttpGet("https://raw.githubusercontent.com/alphavalto-svg/AFKTY/refs/heads/main/AFTKYStandalone") end)
if okBody and type(body)=="string" and #body>0 then
	local lf = loadstring(body)
	if lf then
		local okRun, res = pcall(lf)
		local AFKTY = res
		if type(AFKTY)=="function" then
			local okF, resF = pcall(function() return AFKTY() end)
			if okF and type(resF)=="table" then AFKTY = resF end
		end
		if AFKTY then
			-- Setup event handlers (v3 API)
			if AFKTY.OnConnected and AFKTY.OnConnected.Connect then
				AFKTY.OnConnected:Connect(function()
					pcall(function() AFKTY:SetStatus("Connected") end)
					local gg = (getgenv and getgenv()) or {}
					gg.AFKTY_CONNECTED = true
				end)
			end
			if AFKTY.OnDisconnected and AFKTY.OnDisconnected.Connect then
				AFKTY.OnDisconnected:Connect(function()
					local gg = (getgenv and getgenv()) or {}
					gg.AFKTY_CONNECTED = false
				end)
			end
			if AFKTY.OnCommand and AFKTY.OnCommand.Connect then
				AFKTY.OnCommand:Connect(function(data)
					if data.command == "stop" then
						AFKTY:Disconnect("Stopped by user")
					end
				end)
			end
			if AFKTY.OnError and AFKTY.OnError.Connect then
				AFKTY.OnError:Connect(function(data)
				end)
			end
			
			-- Initialize connection (v3 API)
			pcall(function()
				AFKTY:Init({
					hubKey = "]=] .. HUB_KEY .. [=[",
					userToken = token,
					debug = true
				})
			end)
		end
	end
end

]=])
	q(code)
	reexecQueued = true
end

 
 

-- the color platte cyan theme
local Colors = {
	Background = Color3.fromRGB(15, 17, 26),
	Surface = Color3.fromRGB(22, 27, 40),
	SurfaceLight = Color3.fromRGB(30, 36, 52),
	Primary = Color3.fromRGB(109, 206, 242),
	PrimaryHover = Color3.fromRGB(130, 220, 255),
	Secondary = Color3.fromRGB(159, 18, 57),
	SecondaryHover = Color3.fromRGB(190, 40, 80),
	Text = Color3.fromRGB(243, 244, 246),
	TextMuted = Color3.fromRGB(156, 163, 175),
	TextDark = Color3.fromRGB(107, 114, 128),
	Border = Color3.fromRGB(55, 65, 81),
	Success = Color3.fromRGB(34, 197, 94),
	SuccessBg = Color3.fromRGB(34, 197, 94),
}

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AFKTYStandalone"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
do
	if syn and syn.protect_gui then
		syn.protect_gui(ScreenGui)
	end
	ScreenGui.Parent = parentGui
end

-- main container
local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 380, 0, 300)
Frame.Position = UDim2.new(0.5, -190, 0.5, -150)
Frame.BackgroundColor3 = Color3.fromRGB(0, 22, 38)
Frame.BackgroundTransparency = 0.05
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 16)
Corner.Parent = Frame

local FrameStroke = Instance.new("UIStroke")
FrameStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
FrameStroke.Thickness = 1
FrameStroke.Color = Colors.Border
FrameStroke.Transparency = 0.5
FrameStroke.Parent = Frame

-- header section
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 48)
Header.Position = UDim2.new(0, 0, 0, 0)
Header.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Header.BorderSizePixel = 0
Header.Parent = Frame

local HeaderCorner = Instance.new("UICorner")
HeaderCorner.CornerRadius = UDim.new(0, 16)
HeaderCorner.Parent = Header

-- header fix top rounded 
local HeaderFix = Instance.new("Frame")
HeaderFix.Size = UDim2.new(1, 0, 0, 16)
HeaderFix.Position = UDim2.new(0, 0, 1, -16)
HeaderFix.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
HeaderFix.BorderSizePixel = 0
HeaderFix.Parent = Header

local HeaderBorder = Instance.new("Frame")
HeaderBorder.Size = UDim2.new(1, 0, 0, 1)
HeaderBorder.Position = UDim2.new(0, 0, 1, 0)
HeaderBorder.BackgroundColor3 = Colors.Border
HeaderBorder.BackgroundTransparency = 0.5
HeaderBorder.BorderSizePixel = 0
HeaderBorder.Parent = Header

-- the hub icon
local HubIcon = Instance.new("ImageLabel")
HubIcon.Size = UDim2.new(0, 84, 0, 76)
HubIcon.Position = UDim2.new(-0.0342105255, 0, -0.297414154, 0)
HubIcon.BackgroundTransparency = 1
HubIcon.BorderSizePixel = 0
HubIcon.Image = "rbxassetid://85426628932099"
HubIcon.Parent = Header

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(0, 150, 0, 28)
Title.AnchorPoint = Vector2.new(0, 0.5)
Title.Position = UDim2.new(0.0263157897, 46, 0.5, 0)
Title.BackgroundTransparency = 1
Title.Text = "Universal"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 15
Title.TextColor3 = Colors.Primary
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = Header

local VersionBadge = Instance.new("TextLabel")
VersionBadge.Size = UDim2.new(0, 36, 0, 18)
VersionBadge.AnchorPoint = Vector2.new(0, 0.5)
VersionBadge.Position = UDim2.new(-0.181578949, 198, 0.5, 0)
VersionBadge.BackgroundColor3 = Colors.SurfaceLight
VersionBadge.Text = "v1.1"
VersionBadge.Font = Enum.Font.Code
VersionBadge.TextSize = 11
VersionBadge.TextColor3 = Colors.TextDark
VersionBadge.Parent = Header

local VersionCorner = Instance.new("UICorner")
VersionCorner.CornerRadius = UDim.new(1, 0)
VersionCorner.Parent = VersionBadge

local MinButton = Instance.new("TextButton")
MinButton.Size = UDim2.new(0, 32, 0, 32)
MinButton.AnchorPoint = Vector2.new(0, 0.5)
MinButton.Position = UDim2.new(1, -46, 0.5, 0)
MinButton.BackgroundColor3 = Colors.SurfaceLight
MinButton.BackgroundTransparency = 1
MinButton.TextColor3 = Colors.TextMuted
MinButton.Text = "â€•"
MinButton.Font = Enum.Font.GothamBold
MinButton.TextSize = 16
MinButton.AutoButtonColor = false
MinButton.Parent = Header

local MinCorner = Instance.new("UICorner")
MinCorner.CornerRadius = UDim.new(0, 6)
MinCorner.Parent = MinButton

-- tab bar
local TabBar = Instance.new("Frame")
TabBar.Size = UDim2.new(1, 0, 0, 36)
TabBar.Position = UDim2.new(0, 0, 0, 48)
TabBar.BackgroundTransparency = 1
TabBar.BorderSizePixel = 0
TabBar.Parent = Frame

local TabBorder = Instance.new("Frame")
TabBorder.Size = UDim2.new(1, 0, 0, 1)
TabBorder.Position = UDim2.new(0, 0, 1, 0)
TabBorder.BackgroundColor3 = Colors.Border
TabBorder.BackgroundTransparency = 0.5
TabBorder.BorderSizePixel = 0
TabBorder.Parent = TabBar

local ConnectionTab = Instance.new("TextButton")
ConnectionTab.Size = UDim2.new(0.5, 0, 1, 0)
ConnectionTab.Position = UDim2.new(0, 0, 0, 0)
ConnectionTab.BackgroundColor3 = Colors.Primary
ConnectionTab.BackgroundTransparency = 0.9
ConnectionTab.TextColor3 = Colors.Primary
ConnectionTab.Text = "Connection"
ConnectionTab.Font = Enum.Font.GothamMedium
ConnectionTab.TextSize = 13
ConnectionTab.AutoButtonColor = false
ConnectionTab.BorderSizePixel = 0
ConnectionTab.Parent = TabBar

local ConnectionTabIndicator = Instance.new("Frame")
ConnectionTabIndicator.Size = UDim2.new(1, 0, 0, 2)
ConnectionTabIndicator.Position = UDim2.new(0, 0, 1, -2)
ConnectionTabIndicator.BackgroundColor3 = Colors.Primary
ConnectionTabIndicator.BorderSizePixel = 0
ConnectionTabIndicator.Parent = ConnectionTab

local SettingsTab = Instance.new("TextButton")
SettingsTab.Size = UDim2.new(0.5, 0, 1, 0)
SettingsTab.Position = UDim2.new(0.5, 0, 0, 0)
SettingsTab.BackgroundTransparency = 1
SettingsTab.TextColor3 = Colors.TextMuted
SettingsTab.Text = "Settings"
SettingsTab.Font = Enum.Font.GothamMedium
SettingsTab.TextSize = 13
SettingsTab.AutoButtonColor = false
SettingsTab.BorderSizePixel = 0
SettingsTab.Parent = TabBar

-- content area 
local Content = Instance.new("Frame")
Content.Size = UDim2.new(1, -32, 0, 200)
Content.Position = UDim2.new(0, 16, 0, 88)
Content.BackgroundTransparency = 1
Content.Parent = Frame

-- key id
local SessionLabel = Instance.new("TextLabel")
SessionLabel.Size = UDim2.new(1, 0, 0, 14)
SessionLabel.Position = UDim2.new(0, 4, 0, 0)
SessionLabel.BackgroundTransparency = 1
SessionLabel.Text = "Your Key here:"
SessionLabel.Font = Enum.Font.GothamBold
SessionLabel.TextSize = 10
SessionLabel.TextColor3 = Colors.TextMuted
SessionLabel.TextXAlignment = Enum.TextXAlignment.Left
SessionLabel.Parent = Content

-- token input container field 
local TokenContainer = Instance.new("Frame")
TokenContainer.Size = UDim2.new(1, 0, 0, 48)
TokenContainer.Position = UDim2.new(0, 0, 0, 18)
TokenContainer.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
TokenContainer.BackgroundTransparency = 0.5
TokenContainer.BorderSizePixel = 0
TokenContainer.Parent = Content

local TokenContainerCorner = Instance.new("UICorner")
TokenContainerCorner.CornerRadius = UDim.new(0, 12)
TokenContainerCorner.Parent = TokenContainer

local TokenContainerStroke = Instance.new("UIStroke")
TokenContainerStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
TokenContainerStroke.Thickness = 1
TokenContainerStroke.Color = Colors.Border
TokenContainerStroke.Transparency = 0.5
TokenContainerStroke.Parent = TokenContainer

-- the key icon
local KeyIcon = Instance.new("TextLabel")
KeyIcon.Size = UDim2.new(0, 20, 0, 20)
KeyIcon.AnchorPoint = Vector2.new(0, 0.5)
KeyIcon.Position = UDim2.new(0, 12, 0.5, 0)
KeyIcon.BackgroundTransparency = 1
KeyIcon.Text = "ðŸ”‘"
KeyIcon.TextSize = 14
KeyIcon.TextColor3 = Colors.TextMuted
KeyIcon.Parent = TokenContainer

local TokenInput = Instance.new("TextBox")
TokenInput.Size = UDim2.new(1, -80, 1, 0)
TokenInput.Position = UDim2.new(0, 40, 0, 0)
TokenInput.BackgroundTransparency = 1
TokenInput.TextColor3 = Colors.Text
TokenInput.PlaceholderText = "Enter Token"
TokenInput.PlaceholderColor3 = Colors.TextDark
TokenInput.Font = Enum.Font.Code
TokenInput.TextSize = 16
TokenInput.ClearTextOnFocus = false
TokenInput.TextXAlignment = Enum.TextXAlignment.Center
TokenInput.Parent = TokenContainer

-- button container
local ButtonsContainer = Instance.new("Frame")
ButtonsContainer.Size = UDim2.new(1, 0, 0, 70)
ButtonsContainer.Position = UDim2.new(0, 0, 0, 76)
ButtonsContainer.BackgroundTransparency = 1
ButtonsContainer.Parent = Content

-- connect container
local ConnectButton = Instance.new("TextButton")
ConnectButton.Size = UDim2.new(0.5, -6, 1, 0)
ConnectButton.Position = UDim2.new(0, 0, 0, 0)
ConnectButton.BackgroundColor3 = Colors.Primary
ConnectButton.TextColor3 = Colors.Text
ConnectButton.Text = ""
ConnectButton.AutoButtonColor = false
ConnectButton.Parent = ButtonsContainer

local ConnectCorner = Instance.new("UICorner")
ConnectCorner.CornerRadius = UDim.new(0, 12)
ConnectCorner.Parent = ConnectButton

local ConnectIcon = Instance.new("TextLabel")
ConnectIcon.Size = UDim2.new(1, 0, 0, 24)
ConnectIcon.Position = UDim2.new(0, 0, 0, 12)
ConnectIcon.BackgroundTransparency = 1
ConnectIcon.Text = "â—‰"
ConnectIcon.Font = Enum.Font.GothamBold
ConnectIcon.TextSize = 22
ConnectIcon.TextColor3 = Colors.Text
ConnectIcon.Parent = ConnectButton

local ConnectLabel = Instance.new("TextLabel")
ConnectLabel.Size = UDim2.new(1, 0, 0, 18)
ConnectLabel.Position = UDim2.new(0, 0, 0, 38)
ConnectLabel.BackgroundTransparency = 1
ConnectLabel.Text = "Connect"
ConnectLabel.Font = Enum.Font.GothamBold
ConnectLabel.TextSize = 13
ConnectLabel.TextColor3 = Colors.Text
ConnectLabel.Parent = ConnectButton

-- Disconnect Button
local DisconnectButton = Instance.new("TextButton")
DisconnectButton.Size = UDim2.new(0.5, -6, 1, 0)
DisconnectButton.Position = UDim2.new(0.5, 6, 0, 0)
DisconnectButton.BackgroundColor3 = Colors.SurfaceLight
DisconnectButton.TextColor3 = Colors.TextMuted
DisconnectButton.Text = ""
DisconnectButton.AutoButtonColor = false
DisconnectButton.Parent = ButtonsContainer

local DisconnectCorner = Instance.new("UICorner")
DisconnectCorner.CornerRadius = UDim.new(0, 12)
DisconnectCorner.Parent = DisconnectButton

local DisconnectStroke = Instance.new("UIStroke")
DisconnectStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
DisconnectStroke.Thickness = 1
DisconnectStroke.Color = Colors.Border
DisconnectStroke.Transparency = 0.5
DisconnectStroke.Parent = DisconnectButton

local DisconnectIcon = Instance.new("ImageLabel")
DisconnectIcon.Size = UDim2.new(0, 26, 0, 26)
DisconnectIcon.Position = UDim2.new(0.422619045, 0, 0.142857149, 0)
DisconnectIcon.BackgroundTransparency = 1
DisconnectIcon.BorderSizePixel = 0
DisconnectIcon.Image = "rbxassetid://72218162494547"
DisconnectIcon.Parent = DisconnectButton

local DisconnectLabel = Instance.new("TextLabel")
DisconnectLabel.Size = UDim2.new(1, 0, 0, 18)
DisconnectLabel.Position = UDim2.new(0, 0, 0, 38)
DisconnectLabel.BackgroundTransparency = 1
DisconnectLabel.Text = "Disconnect"
DisconnectLabel.Font = Enum.Font.GothamBold
DisconnectLabel.TextSize = 13
DisconnectLabel.TextColor3 = Colors.TextMuted
DisconnectLabel.Parent = DisconnectButton

-- status Indicator
local StatusContainer = Instance.new("Frame")
StatusContainer.Size = UDim2.new(0, 88, 0, 24)
StatusContainer.Position = UDim2.new(0.557471275, -65, 0.0250000004, 148)
StatusContainer.BackgroundColor3 = Colors.Success
StatusContainer.BackgroundTransparency = 0.85
StatusContainer.BorderSizePixel = 0
StatusContainer.Parent = Content

local StatusCorner = Instance.new("UICorner")
StatusCorner.CornerRadius = UDim.new(1, 0)
StatusCorner.Parent = StatusContainer

local StatusStroke = Instance.new("UIStroke")
StatusStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
StatusStroke.Thickness = 1
StatusStroke.Color = Colors.Success
StatusStroke.Transparency = 0.7
StatusStroke.Parent = StatusContainer

local StatusDot = Instance.new("Frame")
StatusDot.Size = UDim2.new(0, 8, 0, 8)
StatusDot.AnchorPoint = Vector2.new(0, 0.5)
StatusDot.Position = UDim2.new(0, 12, 0.5, 0)
StatusDot.BackgroundColor3 = Colors.Success
StatusDot.BorderSizePixel = 0
StatusDot.Parent = StatusContainer

local StatusDotCorner = Instance.new("UICorner")
StatusDotCorner.CornerRadius = UDim.new(1, 0)
StatusDotCorner.Parent = StatusDot

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1.01191068, -32, 1.04347825, 0)
StatusLabel.Position = UDim2.new(0, 24, 0, -1)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Ready"
StatusLabel.Font = Enum.Font.GothamMedium
StatusLabel.TextSize = 11
StatusLabel.TextColor3 = Colors.Success
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = StatusContainer

-- setting content but hidden by default till switched on
local SettingsContent = Instance.new("Frame")
SettingsContent.Size = UDim2.new(1, -32, 0, 200)
SettingsContent.Position = UDim2.new(0, 16, 0, 88)
SettingsContent.BackgroundTransparency = 1
SettingsContent.Visible = false
SettingsContent.Parent = Frame

-- settings grid
local SettingsGrid = Instance.new("Frame")
SettingsGrid.Size = UDim2.new(1, 0, 0, 100)
SettingsGrid.Position = UDim2.new(0, 0, 0, 0)
SettingsGrid.BackgroundTransparency = 1
SettingsGrid.Parent = SettingsContent

local SettingsGridLayout = Instance.new("UIGridLayout")
SettingsGridLayout.CellSize = UDim2.new(0.5, -6, 0, 44)
SettingsGridLayout.CellPadding = UDim2.new(0, 12, 0, 8)
SettingsGridLayout.FillDirectionMaxCells = 2
SettingsGridLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
SettingsGridLayout.Parent = SettingsGrid

local function makeSettingsCell(idx, title)
	local cell = Instance.new("Frame")
	cell.BackgroundColor3 = Colors.SurfaceLight
	cell.BackgroundTransparency = 0.5
	cell.Parent = SettingsGrid
	
	local cellCorner = Instance.new("UICorner")
	cellCorner.CornerRadius = UDim.new(0, 8)
	cellCorner.Parent = cell
	
	local cellStroke = Instance.new("UIStroke")
	cellStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	cellStroke.Thickness = 1
	cellStroke.Color = Colors.Border
	cellStroke.Transparency = 0.5
	cellStroke.Parent = cell
	
	local box = Instance.new("TextButton")
	box.Size = UDim2.new(0, 20, 0, 20)
	box.Position = UDim2.new(0, 10, 0.5, -10)
	box.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	box.BackgroundTransparency = 0.5
	box.TextColor3 = Colors.Primary
	box.Text = ""
	box.AutoButtonColor = false
	box.Parent = cell
	
	local bc = Instance.new("UICorner")
	bc.CornerRadius = UDim.new(0, 4)
	bc.Parent = box
	
	local bs = Instance.new("UIStroke")
	bs.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	bs.Thickness = 1
	bs.Color = Colors.Border
	bs.Parent = box
	
	local lbl = Instance.new("TextLabel")
	lbl.Size = UDim2.new(1, -44, 1, 0)
	lbl.Position = UDim2.new(0, 38, 0, 0)
	lbl.BackgroundTransparency = 1
	lbl.Text = title
	lbl.TextColor3 = Colors.TextMuted
	lbl.Font = Enum.Font.GothamMedium
	lbl.TextSize = 11
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.TextTruncate = Enum.TextTruncate.AtEnd
	lbl.Parent = cell
	
	local g = (getgenv and getgenv()) or {}
	local active = false
	if idx == 1 then active = Config.JOIN_ACTIVE end
	if idx == 2 then active = Config.LEAVE_ACTIVE end
	if idx == 3 then active = Config.CHAT_ACTIVE end
	if idx == 4 then active = Config.REEXEC_ENABLED end
	

	local function updateCheckbox()
		if active then
			box.Text = "âœ“"
			box.BackgroundColor3 = Colors.Primary
			box.BackgroundTransparency = 0
			bs.Color = Colors.Primary
			lbl.TextColor3 = Colors.Text
		else
			box.Text = ""
			box.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
			box.BackgroundTransparency = 0.5
			bs.Color = Colors.Border
			lbl.TextColor3 = Colors.TextMuted
		end
	end
	updateCheckbox()
	
	local function toggle()
		active = not active
		updateCheckbox()
		if idx == 1 then Config.JOIN_ACTIVE = active end
		if idx == 2 then Config.LEAVE_ACTIVE = active end
		if idx == 3 then Config.CHAT_ACTIVE = active end
		if idx == 4 then 
			Config.REEXEC_ENABLED = active
			if active then
				pcall(function() queueReexec() end)
			end
		end
		local g2 = (getgenv and getgenv()) or {}
		if g2 then
			if idx == 1 then g2.AFKTY_JOIN_ACTIVE = active end
			if idx == 2 then g2.AFKTY_LEAVE_ACTIVE = active end
			if idx == 3 then g2.AFKTY_CHAT_ACTIVE = active end
			if idx == 4 then g2.AFKTY_REEXEC_ENABLED = active end
		end
		pcall(function() saveConfig() end)
	end
	
	box.MouseButton1Click:Connect(toggle)
	cell.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			toggle()
		end
	end)
end

makeSettingsCell(1, "Player Join Alerts")
makeSettingsCell(2, "Player Leave Alerts")
makeSettingsCell(3, "Chat Logging")
makeSettingsCell(4, "Auto Re-execute")

-- settings footer
local SettingsFooterButtons = Instance.new("Frame")
SettingsFooterButtons.Size = UDim2.new(1, 0, 0, 36)
SettingsFooterButtons.Position = UDim2.new(0, 0, 0, 112)
SettingsFooterButtons.BackgroundTransparency = 1
SettingsFooterButtons.Parent = SettingsContent

local SettingsDiscordBtn = Instance.new("TextButton")
SettingsDiscordBtn.Size = UDim2.new(0.5, -6, 0, 32)
SettingsDiscordBtn.Position = UDim2.new(0, 0, 0, 0)
SettingsDiscordBtn.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
SettingsDiscordBtn.TextColor3 = Colors.Text
SettingsDiscordBtn.Text = "â—† Discord"
SettingsDiscordBtn.Font = Enum.Font.GothamBold
SettingsDiscordBtn.TextSize = 12
SettingsDiscordBtn.AutoButtonColor = true
SettingsDiscordBtn.Parent = SettingsFooterButtons

local SettingsDiscordCorner = Instance.new("UICorner")
SettingsDiscordCorner.CornerRadius = UDim.new(0, 8)
SettingsDiscordCorner.Parent = SettingsDiscordBtn

local SettingsWebsiteBtn = Instance.new("TextButton")
SettingsWebsiteBtn.Size = UDim2.new(0.5, -6, 0, 32)
SettingsWebsiteBtn.Position = UDim2.new(0.5, 6, 0, 0)
SettingsWebsiteBtn.BackgroundColor3 = Colors.Primary
SettingsWebsiteBtn.TextColor3 = Colors.Text
SettingsWebsiteBtn.Text = "â—‡ Website"
SettingsWebsiteBtn.Font = Enum.Font.GothamBold
SettingsWebsiteBtn.TextSize = 12
SettingsWebsiteBtn.AutoButtonColor = true
SettingsWebsiteBtn.Parent = SettingsFooterButtons

local SettingsWebsiteCorner = Instance.new("UICorner")
SettingsWebsiteCorner.CornerRadius = UDim.new(0, 8)
SettingsWebsiteCorner.Parent = SettingsWebsiteBtn

-- Credits Label
local CreditsLabel = Instance.new("TextLabel")
CreditsLabel.Size = UDim2.new(1, 0, 0, 20)
CreditsLabel.Position = UDim2.new(0, 0, 0, 156)
CreditsLabel.BackgroundTransparency = 1
CreditsLabel.Text = "Made by Toasty + AlphaValto + Moon"
CreditsLabel.Font = Enum.Font.GothamMedium
CreditsLabel.TextSize = 11
CreditsLabel.TextColor3 = Colors.TextDark
CreditsLabel.Parent = SettingsContent

SettingsWebsiteBtn.MouseButton1Click:Connect(function()
	local g = (getgenv and getgenv()) or {}
	local url = g.AFKTY_SECOND_LINK or "https://afkty.vercel.app"
	if setclipboard then
		pcall(function() setclipboard(url) end)
		pcall(function() game:GetService("StarterGui"):SetCore("SendNotification",{Title="AFKTY",Text="Link copied!",Duration=2}) end)
	else
		pcall(function() game:GetService("StarterGui"):SetCore("SendNotification",{Title="AFKTY",Text="Link: "..url,Duration=5}) end)
	end
end)

SettingsDiscordBtn.MouseButton1Click:Connect(function()
	local link = "https://discord.gg/YyWrDqvCzH"
	local ok = false
	if setclipboard then
		local s, e = pcall(function() setclipboard(link) end)
		if s then ok = true end
	end
	if ok then
		pcall(function() game:GetService("StarterGui"):SetCore("SendNotification",{Title="AFKTY",Text="Discord link copied!",Duration=2}) end)
	else
		pcall(function() game:GetService("StarterGui"):SetCore("SendNotification",{Title="AFKTY",Text="Link: "..link,Duration=5}) end)
	end
end)

-- footer
local Footer = Instance.new("Frame")
Footer.Size = UDim2.new(1, 0, 0, 32)
Footer.Position = UDim2.new(0, 0, 1, -32)
Footer.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Footer.BorderSizePixel = 0
Footer.Parent = Frame

local FooterCorner = Instance.new("UICorner")
FooterCorner.CornerRadius = UDim.new(0, 16)
FooterCorner.Parent = Footer

local FooterFix = Instance.new("Frame")
FooterFix.Size = UDim2.new(1, 0, 0, 16)
FooterFix.Position = UDim2.new(0, 0, 0, 0)
FooterFix.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
FooterFix.Style = Enum.FrameStyle.RobloxSquare
FooterFix.BorderSizePixel = 0
FooterFix.Parent = Footer

local FooterBorder = Instance.new("Frame")
FooterBorder.Size = UDim2.new(1, 0, 0, 1)
FooterBorder.Position = UDim2.new(0, 0, 0, 0)
FooterBorder.BackgroundColor3 = Colors.Border
FooterBorder.BackgroundTransparency = 0.5
FooterBorder.BorderSizePixel = 0
FooterBorder.Parent = Footer

local FooterLeft = Instance.new("TextLabel")
FooterLeft.Size = UDim2.new(0.5, 0, 1, 0)
FooterLeft.Position = UDim2.new(0, 16, 0, 0)
FooterLeft.BackgroundTransparency = 1
FooterLeft.Text = "ID: --"
FooterLeft.Font = Enum.Font.Code
FooterLeft.TextSize = 9
FooterLeft.TextColor3 = Colors.TextDark
FooterLeft.TextXAlignment = Enum.TextXAlignment.Left
FooterLeft.Parent = Footer

local FooterRight = Instance.new("TextLabel")
FooterRight.Size = UDim2.new(0.5, -16, 1, 0)
FooterRight.Position = UDim2.new(0.5, 0, 0, 0)
FooterRight.BackgroundTransparency = 1
FooterRight.Text = "â— Ready"
FooterRight.Font = Enum.Font.Code
FooterRight.TextSize = 9
FooterRight.TextColor3 = Colors.TextDark
FooterRight.TextXAlignment = Enum.TextXAlignment.Right
FooterRight.Parent = Footer

local RestoreButton

local UIS = game:GetService("UserInputService")
local dragging = false
local dragInput
local dragStart
local startPos
local function updateDrag(input)
	local delta = input.Position - dragStart
	Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
Header.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = Frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)
Header.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement then
		dragInput = input
	end
end)
UIS.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		updateDrag(input)
	end
end)

-- button hover on effects
local function addHoverEffect(btn, normalColor, hoverColor, isText)
	btn.MouseEnter:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = hoverColor}):Play()
		if isText then
			TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
		end
	end)
	btn.MouseLeave:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = normalColor}):Play()
		if isText then
			TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
		end
	end)
end

addHoverEffect(ConnectButton, Colors.Primary, Colors.PrimaryHover, false)
addHoverEffect(DisconnectButton, Colors.SurfaceLight, Colors.Secondary, false)
addHoverEffect(MinButton, Colors.SurfaceLight, Colors.SurfaceLight, true)

-- tab switching logic 
local currentTab = "connection"

local function switchToConnection()
	if currentTab == "connection" then return end
	currentTab = "connection"
	
	-- update tab appearance
	ConnectionTab.BackgroundColor3 = Colors.Primary
	ConnectionTab.BackgroundTransparency = 0.9
	ConnectionTab.TextColor3 = Colors.Primary
	ConnectionTabIndicator.Visible = true
	
	SettingsTab.BackgroundTransparency = 1
	SettingsTab.TextColor3 = Colors.TextMuted
	
	-- show or hide contnet
	Content.Visible = true
	SettingsContent.Visible = false
end

local function switchToSettings()
	if currentTab == "settings" then return end
	currentTab = "settings"
	
	-- updating tab appearance
	SettingsTab.BackgroundColor3 = Colors.Primary
	SettingsTab.BackgroundTransparency = 0.9
	SettingsTab.TextColor3 = Colors.Primary
	
	ConnectionTab.BackgroundTransparency = 1
	ConnectionTab.TextColor3 = Colors.TextMuted
	ConnectionTabIndicator.Visible = false
	
	-- create indicator for settings tab if not exists
	local settingsIndicator = SettingsTab:FindFirstChild("SettingsTabIndicator")
	if not settingsIndicator then
		settingsIndicator = Instance.new("Frame")
		settingsIndicator.Name = "SettingsTabIndicator"
		settingsIndicator.Size = UDim2.new(1, 0, 0, 2)
		settingsIndicator.Position = UDim2.new(0, 0, 1, -2)
		settingsIndicator.BackgroundColor3 = Colors.Primary
		settingsIndicator.BorderSizePixel = 0
		settingsIndicator.Parent = SettingsTab
	end
	settingsIndicator.Visible = true
	
	-- show/hide content
	Content.Visible = false
	SettingsContent.Visible = true
end

ConnectionTab.MouseButton1Click:Connect(switchToConnection)
SettingsTab.MouseButton1Click:Connect(switchToSettings)

-- option connections (with rate limit handling)
do
	local function isOn(flag)
		if flag == "AFKTY_JOIN_ACTIVE" then return Config.JOIN_ACTIVE end
		if flag == "AFKTY_LEAVE_ACTIVE" then return Config.LEAVE_ACTIVE end
		if flag == "AFKTY_CHAT_ACTIVE" then return Config.CHAT_ACTIVE end
		if flag == "AFKTY_REEXEC_ENABLED" then return Config.REEXEC_ENABLED end
		local g = (getgenv and getgenv()) or {}
		return g and g[flag]
	end
	
	local function isConnected()
		return AFKTY and AFKTY.IsConnected and pcall(function() return AFKTY:IsConnected() end) and AFKTY:IsConnected()
	end
	
	-- rate limit handling: max 5 notifications per minute = 1 every 12 seconds to be safe
	local NOTIFY_COOLDOWN = 12 -- seconds between notifications
	local lastNotifyTime = 0
	local notifyQueue = {}
	local notifyProcessing = false
	
	local function processNotifyQueue()
		if notifyProcessing then return end
		notifyProcessing = true
		
		spawn(function()
			while #notifyQueue > 0 do
				local now = tick()
				local timeSinceLast = now - lastNotifyTime
				
				if timeSinceLast < NOTIFY_COOLDOWN then
					task.wait(NOTIFY_COOLDOWN - timeSinceLast + 0.1)
				end
				
				if #notifyQueue > 0 and isConnected() then
					local item = table.remove(notifyQueue, 1)
					lastNotifyTime = tick()
					pcall(function()
						if AFKTY and AFKTY.Notify then
							AFKTY:Notify(item.title, item.message)
						end
					end)
				end
			end
			notifyProcessing = false
		end)
	end
	
	local function queueNotify(title, message)
		-- limit queue size to prevent memory issues
		if #notifyQueue < 20 then
			table.insert(notifyQueue, {title = title, message = message})
			processNotifyQueue()
		end
	end
	
	Players.PlayerAdded:Connect(function(plr)
		if isOn("AFKTY_JOIN_ACTIVE") and isConnected() then
			queueNotify("Player Joined", tostring(plr.Name) .. " joined the server")
		end
		-- connect chat listener for new players
		pcall(function()
			plr.Chatted:Connect(function(msg)
				if not isOn("AFKTY_CHAT_ACTIVE") then return end
				if not isConnected() then return end
				pcall(function()
					if AFKTY and AFKTY.Log then
						AFKTY:Log("[" .. tostring(plr.Name) .. "]: " .. tostring(msg))
					end
				end)
			end)
		end)
	end)
	Players.PlayerRemoving:Connect(function(plr)
		if not isOn("AFKTY_LEAVE_ACTIVE") then return end
		if not isConnected() then return end
		queueNotify("Player Left", tostring(plr.Name) .. " left the server")
	end)
	-- connect chat listener for existing players (including LocalPlayer)
	for _, plr in ipairs(Players:GetPlayers()) do
		pcall(function()
			plr.Chatted:Connect(function(msg)
				if not isOn("AFKTY_CHAT_ACTIVE") then return end
				if not isConnected() then return end
				pcall(function()
					if AFKTY and AFKTY.Log then
						AFKTY:Log("[" .. tostring(plr.Name) .. "]: " .. tostring(msg))
					end
				end)
			end)
		end)
	end
end

MinButton.MouseButton1Click:Connect(function()
	Frame.Visible = false
	if not RestoreButton then
		RestoreButton = Instance.new("ImageButton")
		RestoreButton.Size = UDim2.new(0, 84, 0, 76)
		RestoreButton.Position = UDim2.new(1, -94, 1, -86)
		RestoreButton.BackgroundTransparency = 1
		RestoreButton.BorderSizePixel = 0
		RestoreButton.Image = "rbxassetid://85426628932099"
		RestoreButton.ScaleType = Enum.ScaleType.Fit
		RestoreButton.Parent = ScreenGui
		RestoreButton.Draggable = true
		
		RestoreButton.MouseButton1Click:Connect(function()
			Frame.Visible = true
			RestoreButton.Visible = false
		end)
	end
	RestoreButton.Visible = true
end)

-- UI Status Update Helper Functions
local function setStatusConnecting()
	ConnectLabel.Text = "Connecting..."
	ConnectIcon.Text = "â—Ž"
	StatusLabel.Text = "Connecting..."
	StatusContainer.BackgroundColor3 = Color3.fromRGB(234, 179, 8)
	StatusContainer.BackgroundTransparency = 0.85
	StatusStroke.Color = Color3.fromRGB(234, 179, 8)
	StatusDot.BackgroundColor3 = Color3.fromRGB(234, 179, 8)
	StatusLabel.TextColor3 = Color3.fromRGB(234, 179, 8)
	FooterRight.Text = "â— Connecting..."
end

local function setStatusConnected()
	ConnectLabel.Text = "Connected"
	ConnectIcon.Text = "â—‰"
	StatusLabel.Text = "Connected"
	StatusContainer.BackgroundColor3 = Colors.Success
	StatusContainer.BackgroundTransparency = 0.85
	StatusStroke.Color = Colors.Success
	StatusDot.BackgroundColor3 = Colors.Success
	StatusLabel.TextColor3 = Colors.Success
	FooterRight.Text = "â— Online"
end

local function setStatusDisconnected()
	ConnectLabel.Text = "Connect"
	ConnectIcon.Text = "â—‰"
	StatusLabel.Text = "Ready"
	StatusContainer.BackgroundColor3 = Colors.Success
	StatusContainer.BackgroundTransparency = 0.85
	StatusStroke.Color = Colors.Success
	StatusDot.BackgroundColor3 = Colors.Success
	StatusLabel.TextColor3 = Colors.Success
	FooterRight.Text = "â— Ready"
end

local function setStatusError(msg)
	ConnectLabel.Text = "Connect"
	ConnectIcon.Text = "â—‰"
	StatusLabel.Text = msg or "Error"
	StatusContainer.BackgroundColor3 = Colors.Secondary
	StatusContainer.BackgroundTransparency = 0.85
	StatusStroke.Color = Colors.Secondary
	StatusDot.BackgroundColor3 = Colors.Secondary
	StatusLabel.TextColor3 = Colors.Secondary
	FooterRight.Text = "â— Error"
end

ConnectButton.MouseButton1Click:Connect(function()
	if connecting then
		return
	end
	local token = trim(TokenInput.Text or "")
	if token == "" then
		setStatusError("Enter token")
		return
	end
	token = token:upper()
	if #token ~= 6 then
		setStatusError("Invalid format")
		return
	end
	if type(getgenv) == "function" then
		local g = getgenv()
		g.AFKTY_SAVED_TOKEN = token
		g.AFKTY_ORIG_PLACEID = game.PlaceId
	end
	if makefolder and isfolder and not isfolder(SAVE_DIR) then
		pcall(function() makefolder(SAVE_DIR) end)
	end
	if writefile then
		pcall(function() writefile(SAVE_FILE, token) end)
	end

 
	if makefolder and isfolder and not isfolder(SAVE_DIR) then
		pcall(function() makefolder(SAVE_DIR) end)
	end
	if writefile then
		pcall(function() writefile(SAVE_FILE, token) end)
	end
	connecting = true
	setStatusConnecting()
	TokenInput.Active = false
	ConnectButton.Active = false
	local function tryLoadSDK()
		local urls = {
			"https://raw.githubusercontent.com/nouralddin-abdullah/Airlines/refs/heads/main/afkty-v3.luau"
		}
		local lastErr = ""
		if type(loadstring) ~= "function" then
			lastErr = "loadstring unavailable"
			return nil, lastErr
		end
		local function compile(body)
			local lf = loadstring(body)
			if not lf then
				return nil, "failed to compile SDK"
			end
			local ok, res = pcall(lf)
			if ok and res ~= nil then
				return res, nil
			end
			return nil, tostring(res)
		end
		for _, url in ipairs(urls) do
			local ok1, res1 = pcall(function()
				return loadstring(game:HttpGet(url))()
			end)
			if ok1 and res1 ~= nil then
				return res1, nil
			end
			local ok2, raw = pcall(function()
				return game:HttpGetAsync(url)
			end)
			if ok2 and type(raw) == "string" and #raw > 0 then
				local res3, err3 = compile(raw)
				if res3 then
					return res3, nil
				else
					lastErr = err3
				end
			end
			local requestFns = {}
			if syn and syn.request then
				table.insert(requestFns, syn.request)
			end
			if type(http_request) == "function" then
				table.insert(requestFns, http_request)
			end
			if type(request) == "function" then
				table.insert(requestFns, request)
			end
			for _, rf in ipairs(requestFns) do
				local okr, resp = pcall(function()
					return rf({Url = url, Method = "GET"})
				end)
				if okr and resp then
					local code = resp.StatusCode or resp.status_code or resp.status
					local body = resp.Body or resp.body
					if code == 200 and type(body) == "string" and #body > 0 then
						local res5, err5 = compile(body)
						if res5 then
							return res5, nil
						else
							lastErr = err5
						end
					else
						lastErr = "http " .. tostring(code)
					end
				end
			end
		end
		return nil, lastErr
	end
	local sdkErr
	AFKTY, sdkErr = tryLoadSDK()
	if not AFKTY then
		setStatusError("SDK failed")
		TokenInput.Active = true
		ConnectButton.Active = true
		connecting = false
		return
	end
	
	-- Setup event handlers (v3 API)
	if AFKTY.OnConnected and AFKTY.OnConnected.Connect then
		AFKTY.OnConnected:Connect(function()
			setStatusConnected()
			pcall(function() AFKTY:SetStatus("Connected") end)
		end)
	end
	if AFKTY.OnDisconnected and AFKTY.OnDisconnected.Connect then
		AFKTY.OnDisconnected:Connect(function()
			setStatusDisconnected()
			connecting = false
			TokenInput.Active = true
			ConnectButton.Active = true
		end)
	end
	if AFKTY.OnCommand and AFKTY.OnCommand.Connect then
		AFKTY.OnCommand:Connect(function(data)
			if typeof(data) == "table" and tostring(data.command) == "stop" then
				pcall(function() AFKTY:Log("Stop requested by user") end)
				pcall(function() AFKTY:Disconnect("Stopped by user") end)
				if type(stopScript) == "function" then
					pcall(function() stopScript() end)
				end
			end
		end)
	end
	if AFKTY.OnError and AFKTY.OnError.Connect then
		AFKTY.OnError:Connect(function(data)
			local msg = ""
			if typeof(data) == "table" then
				msg = tostring(data.message or data.code or "Error")
			else
				msg = tostring(data)
			end
			StatusLabel.Text = msg
		end)
	end
	
	if type(AFKTY) == "function" then
		local okf, resf = pcall(function() return AFKTY() end)
		if okf and type(resf) == "table" then
			AFKTY = resf
		end
	end
	
	-- Initialize connection (v3 API)
	local initOk, initErr = pcall(function()
		AFKTY:Init({
			hubKey = HUB_KEY,
			userToken = token,
			debug = true
		})
	end)
	
	if not initOk then
		setStatusError("Init failed")
		TokenInput.Active = true
		ConnectButton.Active = true
		connecting = false
		return
	end
	if Config and Config.REEXEC_ENABLED then
		queueReexec()
	end
end)

DisconnectButton.MouseButton1Click:Connect(function()
	if AFKTY and AFKTY.Disconnect then
		pcall(function() AFKTY:Disconnect("Stopped by user") end)
	end
	setStatusDisconnected()
	connecting = false
	TokenInput.Active = true
	ConnectButton.Active = true
end)

spawn(function()
	-- Check if already connected (prevent double execute)
	if type(getgenv)=="function" then
		local g = getgenv()
		if g and g.AFKTY_CONNECTED then
			return
		end
	end
	local fileToken = nil
	if isfile and readfile and isfile(SAVE_FILE) then
		local ok, val = pcall(function() return readfile(SAVE_FILE) end)
		if ok and type(val)=="string" then
			fileToken = (val:gsub("^%s+",""):gsub("%s+$","")):upper()
		end
	end
	if not fileToken and type(getgenv)=="function" then
		local g = getgenv()
		if g and type(g.AFKTY_SAVED_TOKEN)=="string" then
			fileToken = (g.AFKTY_SAVED_TOKEN:gsub("^%s+",""):gsub("%s+$","")):upper()
		end
	end
	-- Retry briefly to allow queued payload to set AFKTY_SAVED_TOKEN after teleport
	if (not fileToken or #fileToken ~= 6) and type(getgenv)=="function" then
		for i = 1, 6 do
			task.wait(1)
			local g = getgenv()
			if g and type(g.AFKTY_SAVED_TOKEN)=="string" then
				fileToken = (g.AFKTY_SAVED_TOKEN:gsub("^%s+",""):gsub("%s+$","")):upper()
				if #fileToken == 6 then break end
			end
		end
	end
	if fileToken and #fileToken==6 then
		TokenInput.Text = fileToken
		FooterLeft.Text = "ID: " .. fileToken

		if not connecting then
			-- Double-check not already connected
			if type(getgenv)=="function" then
				local g = getgenv()
				if g and g.AFKTY_CONNECTED then
					return
				end
			end
			setStatusConnecting()
			TokenInput.Active = false
			ConnectButton.Active = false

			local token = fileToken
			connecting = true
			local function compile(body)
				local lf = loadstring(body)
				if not lf then
					return nil, "failed to compile SDK"
				end
				local ok, res = pcall(lf)
				if ok and res ~= nil then
					return res, nil
				end
				return nil, tostring(res)
			end
			local function tryLoadSDK()
		local urls = {
					"https://raw.githubusercontent.com/nouralddin-abdullah/Airlines/refs/heads/main/afkty-v3.luau"
				}
				local lastErr = ""
				if type(loadstring) ~= "function" then
					lastErr = "loadstring unavailable"
					return nil, lastErr
				end
				for _, url in ipairs(urls) do
					local ok1, res1 = pcall(function()
						return loadstring(game:HttpGet(url))()
					end)
					if ok1 and res1 ~= nil then
						return res1, nil
					end
					local ok2, raw = pcall(function()
						return game:HttpGetAsync(url)
					end)
					if ok2 and type(raw) == "string" and #raw > 0 then
						local res3, err3 = compile(raw)
						if res3 then
							return res3, nil
						else
							lastErr = err3
						end
					end
					local requestFns = {}
					if syn and syn.request then table.insert(requestFns, syn.request) end
					if type(http_request) == "function" then table.insert(requestFns, http_request) end
					if type(request) == "function" then table.insert(requestFns, request) end
					for _, rf in ipairs(requestFns) do
						local okr, resp = pcall(function() return rf({Url = url, Method = "GET"}) end)
						if okr and resp then
							local code = resp.StatusCode or resp.status_code or resp.status
							local body = resp.Body or resp.body
							if code == 200 and type(body) == "string" and #body > 0 then
								local res5, err5 = compile(body)
								if res5 then
									return res5, nil
								else
									lastErr = err5
								end
							else
								lastErr = "http " .. tostring(code)
							end
						end
					end
				end
				return nil, lastErr
			end
			local sdkErr
			AFKTY, sdkErr = tryLoadSDK()
			if not AFKTY then
				setStatusError("SDK failed")
				TokenInput.Active = true
				ConnectButton.Active = true
				connecting = false
				return
			end
			
			-- Setup event handlers (v3 API)
			if AFKTY.OnConnected and AFKTY.OnConnected.Connect then
				AFKTY.OnConnected:Connect(function()
					setStatusConnected()
					pcall(function() AFKTY:SetStatus("Connected") end)
				end)
			end
	if AFKTY.OnDisconnected and AFKTY.OnDisconnected.Connect then
		AFKTY.OnDisconnected:Connect(function()
			setStatusDisconnected()
			connecting = false
			TokenInput.Active = true
			ConnectButton.Active = true
		end)
	end
	if AFKTY.OnCommand and AFKTY.OnCommand.Connect then
		AFKTY.OnCommand:Connect(function(data)
			if typeof(data) == "table" and tostring(data.command) == "stop" then
				pcall(function() AFKTY:Log("Stop requested by user") end)
				pcall(function() AFKTY:Disconnect("Stopped by user") end)
				if type(stopScript) == "function" then
					pcall(function() stopScript() end)
				end
			end
		end)
	end
			if AFKTY.OnError and AFKTY.OnError.Connect then
				AFKTY.OnError:Connect(function(data)
				end)
			end
			
			if type(AFKTY) == "function" then
				local okf, resf = pcall(function() return AFKTY() end)
				if okf and type(resf) == "table" then
					AFKTY = resf
				end
			end
			
			-- Initialize connection (v3 API)
			pcall(function()
				AFKTY:Init({
					hubKey = HUB_KEY,
					userToken = token,
					debug = true
				})
			end)
			
			if Config and Config.REEXEC_ENABLED then
				queueReexec()
			end
		end
	end
end)


-- listen for kicks maybe disconnect or whatever shit
pcall(function()
	GuiService.ErrorMessageChanged:Connect(function(errorMsg)
		if AFKTY and AFKTY.IsConnected and AFKTY:IsConnected() then
			pcall(function()
				AFKTY:Alert(errorMsg)
			end)
		end
	end)
end)

-- error prompet handling and listener
pcall(function()
	local promptGui = CoreGui:FindFirstChild("RobloxPromptGui")
	if promptGui then
		local overlay = promptGui:FindFirstChild("promptOverlay")
		if overlay then
			overlay.ChildAdded:Connect(function(child)
				if child.Name == "ErrorPrompt" then
					task.wait(0.1)
					local errorText = "Unknown Error"
					pcall(function()
						local msgArea = child:FindFirstChild("MessageArea")
						if msgArea then
							local errorFrame = msgArea:FindFirstChild("ErrorFrame")
							if errorFrame then
								local errorMessage = errorFrame:FindFirstChild("ErrorMessage")
								if errorMessage and errorMessage:IsA("TextLabel") then
									errorText = errorMessage.Text
								end
							end
						end
					end)
					if AFKTY and AFKTY.IsConnected and AFKTY:IsConnected() then
						pcall(function()
							AFKTY:Alert(errorText)
						end)
					end
				end
			end)
		end
	end
end)
-- made a new feature 