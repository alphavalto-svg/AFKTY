local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local parentGui = (gethui and gethui()) or game:GetService("CoreGui")
local HUB_KEY = "hub_live_6812bd621eb9953eee0b5421ad25db77c7fcd9aea475bceb"
local GuiService = game:GetService("GuiService")
local CoreGui = game:GetService("CoreGui")
local SAVE_DIR = "AFKTY"
local SAVE_FILE = "AFKTY/token.txt"
local CONFIG_FILE = "AFKTY/config.json"
local Config = {
	JOIN_ACTIVE = false,
	LEAVE_ACTIVE = false,
	CHAT_ACTIVE = false,
	REEXEC_ENABLED = false
}
local function saveConfig()
	if not writefile then return end
	if makefolder then
		pcall(function() makefolder(SAVE_DIR) end)
	end
	local HttpService = game:GetService("HttpService")
	local json = HttpService:JSONEncode(Config)
	pcall(function() writefile(CONFIG_FILE, json) end)
end
local function loadConfig()
	if not readfile then return end
	local ok, content
	if isfile then
		if not isfile(CONFIG_FILE) then return end
		ok, content = pcall(function() return readfile(CONFIG_FILE) end)
	else
		ok, content = pcall(function() return readfile(CONFIG_FILE) end)
		if not ok then return end
	end
	if not ok or not content or content == "" then return end
	local HttpService = game:GetService("HttpService")
	local ok2, data = pcall(function() return HttpService:JSONDecode(content) end)
	if ok2 and type(data) == "table" then
		for k, v in pairs(data) do
			if Config[k] ~= nil then
				Config[k] = v
			end
		end
	end
end

loadConfig()

local function getQueue()
	return (syn and syn.queue_on_teleport) or _G.queue_on_teleport or queue_on_teleport or queueteleport or queue_teleport
end
do
	if type(getgenv) == "function" then
		local g = getgenv()
		if g.AFKTY_REEXEC_ENABLED == nil then g.AFKTY_REEXEC_ENABLED = false end
		if g.AFKTY_JOIN_ACTIVE == nil then g.AFKTY_JOIN_ACTIVE = false end
		if g.AFKTY_LEAVE_ACTIVE == nil then g.AFKTY_LEAVE_ACTIVE = false end
		if g.AFKTY_CHAT_ACTIVE == nil then g.AFKTY_CHAT_ACTIVE = false end
	end
end
local function TryLoadSDK()
	if type(loadstring) ~= "function" then
		return nil, "loadstring unavailable"
	end
	local url = "https://raw.githubusercontent.com/alphavalto-svg/AFKTY/refs/heads/main/AFTKYStandalone"
	local okBody, body = pcall(function() return game:HttpGet(url) end)
	if not okBody or type(body) ~= "string" or #body == 0 then
		return nil, "failed to fetch SDK"
	end
	local lf = loadstring(body)
	if not lf then
		return nil, "failed to compile SDK"
	end
	local okRun, res = pcall(lf)
	if okRun and res ~= nil then
		return res, nil
	end
	return nil, tostring(res)
end
local AFKTY = nil
local function trim(s)
	return (s:gsub("^%s+", ""):gsub("%s+$", ""))
end
local connecting = false
local SAVE_DIR = "AFKTY"
local g.AFKTY_SAVED_TOKEN = "AFKTY/token.txt"
local SAVE_FILE = "AFKTY/token.txt"
local reexecQueued = false
local function getSavedToken()
	local tok = ""
	if isfile and readfile and isfile(SAVE_FILE) then
		local ok, val = pcall(function() return readfile(SAVE_FILE) end)
		if ok and type(val)=="string" then
			tok = (val:gsub("^%s+",""):gsub("%s+$","")):upper()
		end
	end
	if tok == "" and type(getgenv)=="function" then
		local g = getgenv()
		if g and type(g.AFKTY_SAVED_TOKEN)=="string" then
			tok = (g.AFKTY_SAVED_TOKEN:gsub("^%s+",""):gsub("%s+$","")):upper()
		end
	end
	return tok
end
local function queueReexec()
	if not (Config and Config.REEXEC_ENABLED) then return end
	if reexecQueued then return end
	local q = getQueue()
	if not q then
		return
	end
	local embedToken = getSavedToken()
	local code = ([=[
if not game:IsLoaded() then game.Loaded:Wait() end
repeat task.wait() until game:GetService("Players").LocalPlayer
task.wait(1)
local g = (getgenv and getgenv()) or {}
g.AFKTY_HUB_KEY = "]=] .. HUB_KEY .. [=["
g.AFKTY_SAVED_TOKEN = "]=] .. embedToken .. [=["
local token = ""
if isfile and readfile and isfile("AFKTY/token.txt") then
	local ok, val = pcall(function() return readfile("AFKTY/token.txt") end)
	if ok and type(val)=="string" then token = (val:gsub("^%s+",""):gsub("%s+$","")):upper() end
end
if token == "" then
	token = g.AFKTY_SAVED_TOKEN or ""
end
local okBody, body = pcall(function() return game:HttpGet("https://raw.githubusercontent.com/alphavalto-svg/AFKTY/refs/heads/main/AFTKYStandalone") end)
if okBody and type(body)=="string" and #body>0 then
	local lf = loadstring(body)
	if lf then
		local okRun, res = pcall(lf)
		local AFKTY = res
		if type(AFKTY)=="function" then
			local okF, resF = pcall(function() return AFKTY() end)
			if okF and type(resF)=="table" then AFKTY = resF end
		end
		if AFKTY then
			-- Setup event handlers (v3 API)
			if AFKTY.OnConnected and AFKTY.OnConnected.Connect then
				AFKTY.OnConnected:Connect(function()
					pcall(function() AFKTY:SetStatus("Connected") end)
				end)
			end
			if AFKTY.OnDisconnected and AFKTY.OnDisconnected.Connect then
				AFKTY.OnDisconnected:Connect(function()
				end)
			end
			if AFKTY.OnCommand and AFKTY.OnCommand.Connect then
				AFKTY.OnCommand:Connect(function(data)
					if data.command == "stop" then
						AFKTY:Disconnect("Stopped by user")
					end
				end)
			end
			if AFKTY.OnError and AFKTY.OnError.Connect then
				AFKTY.OnError:Connect(function(data)
				end)
			end
			
			-- Initialize connection (v3 API)
			pcall(function()
				AFKTY:Init({
					hubKey = "]=] .. HUB_KEY .. [=[",
					userToken = token,
					debug = true
				})
			end)
		end
	end
end

]=])
	q(code)
	reexecQueued = true
end

 
 

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AFKTYStandalone"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
do
	if syn and syn.protect_gui then
		syn.protect_gui(ScreenGui)
	end
	ScreenGui.Parent = parentGui
end

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 360, 0, 200)
Frame.Position = UDim2.new(0.5, -180, 0.5, -100)
Frame.BackgroundColor3 = Color3.fromRGB(18, 14, 26)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 10)
Corner.Parent = Frame
local Shimmer = Instance.new("UIStroke")
Shimmer.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
Shimmer.Thickness = 2
Shimmer.Color = Color3.fromRGB(150, 100, 255)
Shimmer.Transparency = 0.2
Shimmer.Parent = Frame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 24)
Title.Position = UDim2.new(0, 0, 0, 10)
Title.BackgroundTransparency = 1
Title.Text = "AFKTY Standalone v1.0"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 20
Title.TextColor3 = Color3.fromRGB(200, 160, 255)
Title.TextXAlignment = Enum.TextXAlignment.Center
Title.Parent = Frame

local DiscordButton = Instance.new("TextButton")
DiscordButton.Size = UDim2.new(0, 90, 0, 24)
DiscordButton.Position = UDim2.new(0, 10, 0, 10)
DiscordButton.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
DiscordButton.TextColor3 = Color3.fromRGB(255, 255, 255)
DiscordButton.Text = "Discord"
DiscordButton.Font = Enum.Font.GothamBold
DiscordButton.TextSize = 14
DiscordButton.TextScaled = false
DiscordButton.AutoButtonColor = true
DiscordButton.TextWrapped = false
DiscordButton.Parent = Frame

local MinButton = Instance.new("TextButton")
MinButton.Size = UDim2.new(0, 30, 0, 24)
MinButton.Position = UDim2.new(1, -40, 0, 10)
MinButton.BackgroundColor3 = Color3.fromRGB(75, 45, 160)
MinButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinButton.Text = "â€”"
MinButton.Font = Enum.Font.GothamBold
MinButton.TextSize = 16
MinButton.AutoButtonColor = true
MinButton.Parent = Frame
local MinCorner = Instance.new("UICorner")
MinCorner.CornerRadius = UDim.new(1, 0)
MinCorner.Parent = MinButton

local TokenInput = Instance.new("TextBox")
TokenInput.Size = UDim2.new(1, -20, 0, 36)
TokenInput.Position = UDim2.new(0, 10, 0, 44)
TokenInput.BackgroundColor3 = Color3.fromRGB(26, 20, 34)
TokenInput.TextColor3 = Color3.fromRGB(255, 255, 255)
TokenInput.Text = ""
TokenInput.PlaceholderText = "Enter Token"
TokenInput.Font = Enum.Font.Gotham
TokenInput.TextSize = 16
TokenInput.ClearTextOnFocus = false
TokenInput.Parent = Frame

local InputCorner = Instance.new("UICorner")
InputCorner.CornerRadius = UDim.new(0, 8)
InputCorner.Parent = TokenInput
do
	local guard = false
	TokenInput:GetPropertyChangedSignal("Text"):Connect(function()
		if guard then return end
		local txt = TokenInput.Text or ""
		local sanitized = txt:gsub("%s+", ""):upper():gsub("[^%w]", "")
		if #sanitized > 6 then
			sanitized = sanitized:sub(1, 6)
		end
		if sanitized ~= txt then
			guard = true
			TokenInput.Text = sanitized
			guard = false
		end
	end)
end

local ConnectButton = Instance.new("TextButton")
ConnectButton.Size = UDim2.new(0.5, -15, 0, 36)
ConnectButton.Position = UDim2.new(0, 10, 0, 90)
ConnectButton.BackgroundColor3 = Color3.fromRGB(110, 70, 220)
ConnectButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ConnectButton.Text = "Connect"
ConnectButton.Font = Enum.Font.GothamBold
ConnectButton.TextSize = 16
ConnectButton.AutoButtonColor = true
ConnectButton.Parent = Frame

local ButtonCorner = Instance.new("UICorner")
ButtonCorner.CornerRadius = UDim.new(0, 8)
ButtonCorner.Parent = ConnectButton
local DisconnectButton = Instance.new("TextButton")
DisconnectButton.Size = UDim2.new(0.5, -15, 0, 36)
DisconnectButton.Position = UDim2.new(0.5, 5, 0, 90)
DisconnectButton.BackgroundColor3 = Color3.fromRGB(160, 60, 80)
DisconnectButton.TextColor3 = Color3.fromRGB(255, 255, 255)
DisconnectButton.Text = "Disconnect"
DisconnectButton.Font = Enum.Font.GothamBold
DisconnectButton.TextSize = 16
DisconnectButton.AutoButtonColor = true
DisconnectButton.Parent = Frame
local DisconnectCorner = Instance.new("UICorner")
DisconnectCorner.CornerRadius = UDim.new(0, 8)
DisconnectCorner.Parent = DisconnectButton

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -20, 0, 24)
StatusLabel.Position = UDim2.new(0, 10, 0, 132)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = ""
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 14
StatusLabel.TextColor3 = Color3.fromRGB(220, 220, 230)
StatusLabel.Parent = Frame
local ExpandButton = Instance.new("TextButton")
ExpandButton.Size = UDim2.new(1, -20, 0, 36)
ExpandButton.Position = UDim2.new(0, 10, 0, 160)
ExpandButton.BackgroundColor3 = Color3.fromRGB(110, 70, 220)
ExpandButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ExpandButton.Text = "Expand"
ExpandButton.Font = Enum.Font.GothamBold
ExpandButton.TextSize = 18
ExpandButton.AutoButtonColor = true
ExpandButton.Parent = Frame
local ExpandCorner = Instance.new("UICorner")
ExpandCorner.CornerRadius = UDim.new(0, 8)
ExpandCorner.Parent = ExpandButton

-- creator label

local RestoreButton
local SlidePanel

local UIS = game:GetService("UserInputService")
local dragging = false
local dragInput
local dragStart
local startPos
local function updateDrag(input)
	local delta = input.Position - dragStart
	Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end
Frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = Frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)
Frame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement then
		dragInput = input
	end
end)
UIS.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		updateDrag(input)
	end
end)

-- Expandable Panel
SlidePanel = Instance.new("Frame")
SlidePanel.Size = UDim2.new(0, 360, 0, 160)
SlidePanel.BackgroundColor3 = Color3.fromRGB(18, 14, 26)
SlidePanel.BorderSizePixel = 0
SlidePanel.Visible = false
SlidePanel.Parent = ScreenGui
local SlideCorner = Instance.new("UICorner")
SlideCorner.CornerRadius = UDim.new(0, 10)
SlideCorner.Parent = SlidePanel
local PanelStroke = Instance.new("UIStroke")
PanelStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
PanelStroke.Thickness = 2
PanelStroke.Color = Color3.fromRGB(150, 100, 255)
PanelStroke.Transparency = 0.2
PanelStroke.Parent = SlidePanel
local PanelCreator = Instance.new("TextLabel")
PanelCreator.Size = UDim2.new(0, 300, 0, 18)
PanelCreator.Position = UDim2.new(0.5, -150, 0, 8)
PanelCreator.BackgroundTransparency = 1
PanelCreator.Text = "Creator: Toasty + AlphaValto"
PanelCreator.Font = Enum.Font.GothamSemibold
PanelCreator.TextSize = 14
PanelCreator.TextColor3 = Color3.fromRGB(200, 160, 255)
PanelCreator.TextXAlignment = Enum.TextXAlignment.Center
PanelCreator.Parent = SlidePanel
local FuncGrid = Instance.new("Frame")
FuncGrid.Size = UDim2.new(0, 328, 0, 96)
FuncGrid.Position = UDim2.new(0.5, -164, 0, 32)
FuncGrid.BackgroundTransparency = 1
FuncGrid.Parent = SlidePanel
local Grid = Instance.new("UIGridLayout")
Grid.CellSize = UDim2.new(0, 160, 0, 44)
Grid.CellPadding = UDim2.new(0, 8, 0, 8)
Grid.FillDirectionMaxCells = 2
Grid.HorizontalAlignment = Enum.HorizontalAlignment.Center
Grid.Parent = FuncGrid
local function makeCell(idx, title)
	local cell = Instance.new("Frame")
	cell.BackgroundTransparency = 1
	cell.Parent = FuncGrid
	local list = Instance.new("UIListLayout")
	list.FillDirection = Enum.FillDirection.Horizontal
	list.HorizontalAlignment = Enum.HorizontalAlignment.Left
	list.VerticalAlignment = Enum.VerticalAlignment.Center
	list.Padding = UDim.new(0, 8)
	list.Parent = cell
	local box = Instance.new("TextButton")
	box.Size = UDim2.new(0, 24, 0, 24)
	box.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
	box.TextColor3 = Color3.fromRGB(255, 255, 255)
	box.Text = ""
	box.AutoButtonColor = true
	box.Parent = cell
	local bc = Instance.new("UICorner")
	bc.CornerRadius = UDim.new(0, 6)
	bc.Parent = box
	local bs = Instance.new("UIStroke")
	bs.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	bs.Thickness = 2
	bs.Color = Color3.fromRGB(150, 100, 255)
	bs.Transparency = 0
	bs.Parent = box
	local lbl = Instance.new("TextLabel")
	lbl.Size = UDim2.new(1, -40, 1, 0)
	lbl.BackgroundTransparency = 1
	lbl.Text = title
	lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
	lbl.Font = Enum.Font.GothamBold
	lbl.TextSize = 14
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.Parent = cell
	local active = false
	if idx == 1 then active = Config.JOIN_ACTIVE end
	if idx == 2 then active = Config.LEAVE_ACTIVE end
	if idx == 3 then active = Config.CHAT_ACTIVE end
	if idx == 4 then active = Config.REEXEC_ENABLED end
	box.Text = active and "X" or ""
	box.MouseButton1Click:Connect(function()
		active = not active
		box.Text = active and "X" or ""
		if idx == 1 then Config.JOIN_ACTIVE = active end
		if idx == 2 then Config.LEAVE_ACTIVE = active end
		if idx == 3 then Config.CHAT_ACTIVE = active end
		if idx == 4 then Config.REEXEC_ENABLED = active
			if active then
				pcall(function() queueReexec() end)
			end
		end
		local g2 = (getgenv and getgenv()) or {}
		if idx == 1 then g2.AFKTY_FUNC1_ACTIVE = active end
		if idx == 2 then g2.AFKTY_FUNC2_ACTIVE = active end
		if idx == 3 then g2.AFKTY_FUNC3_ACTIVE = active end
		if idx == 4 then g2.AFKTY_REEXEC_ENABLED = active end
		pcall(function() saveConfig() end)
	end)
end
makeCell(1, "Players Join")
makeCell(2, "Players Leave")
makeCell(3, "Chat Log")
makeCell(4, "Reexecute Automatic")

-- Option connections
do
	Players.PlayerAdded:Connect(function(plr)
		if not (Config and Config.JOIN_ACTIVE) then return end
		pcall(function()
			if AFKTY and AFKTY.Log then
				AFKTY:Log("PlayerJoin, warn", "warn")
			end
		end)
	end)
	Players.PlayerRemoving:Connect(function(plr)
		if not (Config and Config.LEAVE_ACTIVE) then return end
		pcall(function()
			if AFKTY and AFKTY.Log then
				AFKTY:Log("PlayerLeave, info", "info")
			end
		end)
	end)
	if LocalPlayer and LocalPlayer.Chatted then
		LocalPlayer.Chatted:Connect(function(msg)
			if not (Config and Config.CHAT_ACTIVE) then return end
			pcall(function()
				if AFKTY and AFKTY.Log then
					AFKTY:Log("Chat Log: "..tostring(msg), "info")
				end
			end)
		end)
	end
end

local function panelAnchorPos()
	return UDim2.new(Frame.Position.X.Scale, Frame.Position.X.Offset, Frame.Position.Y.Scale, Frame.Position.Y.Offset + Frame.Size.Y.Offset)
end
local function syncPanelAnchor()
	if not SlidePanel then return end
	SlidePanel.Position = panelAnchorPos()
	SlidePanel.Size = UDim2.new(0, Frame.Size.X.Offset, 0, SlidePanel.Size.Y.Offset)
end
Frame:GetPropertyChangedSignal("Position"):Connect(syncPanelAnchor)
Frame:GetPropertyChangedSignal("Size"):Connect(syncPanelAnchor)
local panelOpen = false
local function togglePanel()
	if not panelOpen then
		SlidePanel.Visible = true
		SlidePanel.Position = panelAnchorPos()
		SlidePanel.Size = UDim2.new(0, Frame.Size.X.Offset, 0, 0)
		panelOpen = true
		ExpandButton.Text = "Close"
		local t = TweenService:Create(SlidePanel, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(0, Frame.Size.X.Offset, 0, 160)})
		t:Play()
	else
		panelOpen = false
		ExpandButton.Text = "Expand"
		local t = TweenService:Create(SlidePanel, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(0, Frame.Size.X.Offset, 0, 0)})
		t:Play()
		t.Completed:Wait()
		SlidePanel.Visible = false
	end
end

ExpandButton.MouseButton1Click:Connect(togglePanel)
DiscordButton.Parent = SlidePanel
DiscordButton.Position = UDim2.new(0, 10, 1, -28)
DiscordButton.Size = UDim2.new(0, 100, 0, 24)
local DiscordCorner = Instance.new("UICorner")
DiscordCorner.CornerRadius = UDim.new(1, 0)
DiscordCorner.Parent = DiscordButton
local LinkButton = Instance.new("TextButton")
LinkButton.Size = UDim2.new(0, 100, 0, 24)
LinkButton.Position = UDim2.new(1, -110, 1, -28)
LinkButton.BackgroundColor3 = Color3.fromRGB(110, 70, 220)
LinkButton.TextColor3 = Color3.fromRGB(255, 255, 255)
LinkButton.Text = "Website"
LinkButton.Font = Enum.Font.GothamBold
LinkButton.TextSize = 14
LinkButton.AutoButtonColor = true
LinkButton.Parent = SlidePanel
local LinkCorner = Instance.new("UICorner")
LinkCorner.CornerRadius = UDim.new(0, 8)
LinkCorner.Parent = LinkButton
LinkButton.MouseButton1Click:Connect(function()
	local g = (getgenv and getgenv()) or {}
	local url = g.AFKTY_SECOND_LINK or "https://afkty.vercel.app"
	if setclipboard then
		pcall(function() setclipboard(url) end)
	else
		pcall(function() game:GetService("StarterGui"):SetCore("SendNotification",{Title="AFKTY",Text="Link: "..url,Duration=5}) end)
	end
end)

--Discord Button
DiscordButton.MouseButton1Click:Connect(function()
	local link = "https://discord.gg/YyWrDqvCzH"
	local ok = false
	if setclipboard then
		local s, e = pcall(function() setclipboard(link) end)
		if s then ok = true end
	end
	if ok then
		pcall(function() game:GetService("StarterGui"):SetCore("SendNotification",{Title="AFKTY",Text="Discord link copied",Duration=2}) end)
	else
		pcall(function() game:GetService("StarterGui"):SetCore("SendNotification",{Title="AFKTY",Text="Link: "..link,Duration=5}) end)
	end
end)

MinButton.MouseButton1Click:Connect(function()
	Frame.Visible = false
	if SlidePanel then
		SlidePanel.Visible = false
	end
	panelOpen = false
	ExpandButton.Text = "Expand"
	if not RestoreButton then
		RestoreButton = Instance.new("TextButton")
		RestoreButton.Size = UDim2.new(0, 40, 0, 40)
		RestoreButton.Position = UDim2.new(1, -60, 1, -60)
		RestoreButton.BackgroundColor3 = Color3.fromRGB(110, 70, 220)
		RestoreButton.TextColor3 = Color3.fromRGB(255, 255, 255)
		RestoreButton.Text = "AFKTY"
		RestoreButton.Font = Enum.Font.GothamBold
		RestoreButton.TextSize = 12
		RestoreButton.AutoButtonColor = true
		RestoreButton.TextWrapped = true
		RestoreButton.Parent = ScreenGui
		RestoreButton.Draggable = true
		local rc = Instance.new("UICorner")
		rc.CornerRadius = UDim.new(1, 0)
		rc.Parent = RestoreButton
		RestoreButton.MouseButton1Click:Connect(function()
			Frame.Visible = true
			RestoreButton.Visible = false
		end)
	end
	RestoreButton.Visible = true
end)

ConnectButton.MouseButton1Click:Connect(function()
	if connecting then
		return
	end
	local token = trim(TokenInput.Text or "")
	if token == "" then
		StatusLabel.Text = "Please enter your token"
		return
	end
	token = token:upper()
	if #token ~= 6 then
		StatusLabel.Text = "Invalid token format"
		return
	end
	if type(getgenv) == "function" then
		local g = getgenv()
		g.AFKTY_SAVED_TOKEN = token
		g.AFKTY_ORIG_PLACEID = game.PlaceId
	end
	if makefolder then
		pcall(function() makefolder(SAVE_DIR) end)
	end
	if writefile then
		pcall(function() writefile(SAVE_FILE, token) end)
	end
	connecting = true
	ConnectButton.AutoButtonColor = false
	ConnectButton.Text = "Connecting..."
	TokenInput.Active = false
	ConnectButton.Active = false
	local function tryLoadSDK()
		local urls = {
			"https://raw.githubusercontent.com/nouralddin-abdullah/Airlines/refs/heads/main/afkty-v3.luau"
		}
		local lastErr = ""
		if type(loadstring) ~= "function" then
			lastErr = "loadstring unavailable"
			return nil, lastErr
		end
		local function compile(body)
			local lf = loadstring(body)
			if not lf then
				return nil, "failed to compile SDK"
			end
			local ok, res = pcall(lf)
			if ok and res ~= nil then
				return res, nil
			end
			return nil, tostring(res)
		end
		for _, url in ipairs(urls) do
			local ok1, res1 = pcall(function()
				return loadstring(game:HttpGet(url))()
			end)
			if ok1 and res1 ~= nil then
				return res1, nil
			end
			local ok2, raw = pcall(function()
				return game:HttpGetAsync(url)
			end)
			if ok2 and type(raw) == "string" and #raw > 0 then
				local res3, err3 = compile(raw)
				if res3 then
					return res3, nil
				else
					lastErr = err3
				end
			end
			local requestFns = {}
			if syn and syn.request then
				table.insert(requestFns, syn.request)
			end
			if type(http_request) == "function" then
				table.insert(requestFns, http_request)
			end
			if type(request) == "function" then
				table.insert(requestFns, request)
			end
			for _, rf in ipairs(requestFns) do
				local okr, resp = pcall(function()
					return rf({Url = url, Method = "GET"})
				end)
				if okr and resp then
					local code = resp.StatusCode or resp.status_code or resp.status
					local body = resp.Body or resp.body
					if code == 200 and type(body) == "string" and #body > 0 then
						local res5, err5 = compile(body)
						if res5 then
							return res5, nil
						else
							lastErr = err5
						end
					else
						lastErr = "http " .. tostring(code)
					end
				end
			end
		end
		return nil, lastErr
	end
	local sdkErr
	AFKTY, sdkErr = tryLoadSDK()
	if not AFKTY then
		StatusLabel.Text = "SDK load failed: " .. (sdkErr or "unknown")
		ConnectButton.AutoButtonColor = true
		ConnectButton.Text = "Connect"
		TokenInput.Active = true
		ConnectButton.Active = true
		connecting = false
		return
	end
	
	-- Setup event handlers (v3 API)
	if AFKTY.OnConnected and AFKTY.OnConnected.Connect then
		AFKTY.OnConnected:Connect(function()
			StatusLabel.Text = "Connected"
			ConnectButton.Text = "Connected"
			pcall(function() AFKTY:SetStatus("Connected") end)
		end)
	end
	if AFKTY.OnDisconnected and AFKTY.OnDisconnected.Connect then
		AFKTY.OnDisconnected:Connect(function()
			StatusLabel.Text = "Disconnected"
			ConnectButton.Text = "Connect"
			connecting = false
			TokenInput.Active = true
			ConnectButton.Active = true
			ConnectButton.AutoButtonColor = true
		end)
	end
	if AFKTY.OnCommand and AFKTY.OnCommand.Connect then
		AFKTY.OnCommand:Connect(function(data)
			if typeof(data) == "table" and tostring(data.command) == "stop" then
				pcall(function() AFKTY:Log("Stop requested by user") end)
				pcall(function() AFKTY:Disconnect("Stopped by user") end)
				if type(stopScript) == "function" then
					pcall(function() stopScript() end)
				end
			end
		end)
	end
	if AFKTY.OnError and AFKTY.OnError.Connect then
		AFKTY.OnError:Connect(function(data)
			local msg = ""
			if typeof(data) == "table" then
				msg = tostring(data.message or data.code or "Error")
			else
				msg = tostring(data)
			end
			StatusLabel.Text = msg
		end)
	end
	
	if type(AFKTY) == "function" then
		local okf, resf = pcall(function() return AFKTY() end)
		if okf and type(resf) == "table" then
			AFKTY = resf
		end
	end
	
	-- Initialize connection (v3 API)
	local initOk, initErr = pcall(function()
		AFKTY:Init({
			hubKey = HUB_KEY,
			userToken = token,
			debug = true
		})
	end)
	
	if not initOk then
		StatusLabel.Text = "Init failed: " .. tostring(initErr)
		ConnectButton.Text = "Connect"
		TokenInput.Active = true
		ConnectButton.Active = true
		ConnectButton.AutoButtonColor = true
		connecting = false
		return
	end
	if Config and Config.REEXEC_ENABLED then
		queueReexec()
	end
end)
DisconnectButton.MouseButton1Click:Connect(function()
	if AFKTY and AFKTY.Disconnect then
		pcall(function() AFKTY:Disconnect("Stopped by user") end)
	end
	StatusLabel.Text = "Disconnected"
	ConnectButton.Text = "Connect"
	connecting = false
	TokenInput.Active = true
	ConnectButton.Active = true
	ConnectButton.AutoButtonColor = true
end)
spawn(function()
	if Config and Config.REEXEC_ENABLED then
		return
	end
	local fileToken = getSavedToken()
	if fileToken and #fileToken==6 then
		TokenInput.Text = fileToken

		if not connecting then
			ConnectButton.AutoButtonColor = false
			ConnectButton.Text = "Connecting..."
			TokenInput.Active = false
			ConnectButton.Active = false

			local token = fileToken
			connecting = true
			local function compile(body)
				local lf = loadstring(body)
				if not lf then
					return nil, "failed to compile SDK"
				end
				local ok, res = pcall(lf)
				if ok and res ~= nil then
					return res, nil
				end
				return nil, tostring(res)
			end
			local function tryLoadSDK()
		local urls = {
					"https://raw.githubusercontent.com/nouralddin-abdullah/Airlines/refs/heads/main/afkty-v3.luau"
				}
				local lastErr = ""
				if type(loadstring) ~= "function" then
					lastErr = "loadstring unavailable"
					return nil, lastErr
				end
				for _, url in ipairs(urls) do
					local ok1, res1 = pcall(function()
						return loadstring(game:HttpGet(url))()
					end)
					if ok1 and res1 ~= nil then
						return res1, nil
					end
					local ok2, raw = pcall(function()
						return game:HttpGetAsync(url)
					end)
					if ok2 and type(raw) == "string" and #raw > 0 then
						local res3, err3 = compile(raw)
						if res3 then
							return res3, nil
						else
							lastErr = err3
						end
					end
					local requestFns = {}
					if syn and syn.request then table.insert(requestFns, syn.request) end
					if type(http_request) == "function" then table.insert(requestFns, http_request) end
					if type(request) == "function" then table.insert(requestFns, request) end
					for _, rf in ipairs(requestFns) do
						local okr, resp = pcall(function() return rf({Url = url, Method = "GET"}) end)
						if okr and resp then
							local code = resp.StatusCode or resp.status_code or resp.status
							local body = resp.Body or resp.body
							if code == 200 and type(body) == "string" and #body > 0 then
								local res5, err5 = compile(body)
								if res5 then
									return res5, nil
								else
									lastErr = err5
								end
							else
								lastErr = "http " .. tostring(code)
							end
						end
					end
				end
				return nil, lastErr
			end
			local sdkErr
			AFKTY, sdkErr = tryLoadSDK()
			if not AFKTY then
				StatusLabel.Text = "SDK load failed: " .. (sdkErr or "unknown")
				ConnectButton.AutoButtonColor = true
				ConnectButton.Text = "Connect"
				TokenInput.Active = true
				ConnectButton.Active = true
				connecting = false
				return
			end
			
			-- Setup event handlers (v3 API)
			if AFKTY.OnConnected and AFKTY.OnConnected.Connect then
				AFKTY.OnConnected:Connect(function()
					StatusLabel.Text = "Connected"
					ConnectButton.Text = "Connected"
					pcall(function() AFKTY:SetStatus("Connected") end)
				end)
			end
	if AFKTY.OnDisconnected and AFKTY.OnDisconnected.Connect then
		AFKTY.OnDisconnected:Connect(function()
			StatusLabel.Text = "Disconnected"
			ConnectButton.Text = "Connect"
			connecting = false
			TokenInput.Active = true
			ConnectButton.Active = true
			ConnectButton.AutoButtonColor = true
		end)
	end
	if AFKTY.OnCommand and AFKTY.OnCommand.Connect then
		AFKTY.OnCommand:Connect(function(data)
			if typeof(data) == "table" and tostring(data.command) == "stop" then
				pcall(function() AFKTY:Log("Stop requested by user") end)
				pcall(function() AFKTY:Disconnect("Stopped by user") end)
				if type(stopScript) == "function" then
					pcall(function() stopScript() end)
				end
			end
		end)
	end
			if AFKTY.OnError and AFKTY.OnError.Connect then
				AFKTY.OnError:Connect(function(data)
				end)
			end
			
			if type(AFKTY) == "function" then
				local okf, resf = pcall(function() return AFKTY() end)
				if okf and type(resf) == "table" then
					AFKTY = resf
				end
			end
			
			-- Initialize connection (v3 API)
			pcall(function()
				AFKTY:Init({
					hubKey = HUB_KEY,
					userToken = token,
					debug = true
				})
			end)
			
			if Config and Config.REEXEC_ENABLED then
				queueReexec()
			end
		end
	end
end)


-- listen for kicks maybe disconnect or whatever shit
pcall(function()
	GuiService.ErrorMessageChanged:Connect(function(errorMsg)
		if AFKTY and AFKTY.IsConnected and AFKTY:IsConnected() then
			pcall(function()
				AFKTY:Alert(errorMsg)
			end)
		end
	end)
end)

-- error prompet handling and listener
pcall(function()
	local promptGui = CoreGui:FindFirstChild("RobloxPromptGui")
	if promptGui then
		local overlay = promptGui:FindFirstChild("promptOverlay")
		if overlay then
			overlay.ChildAdded:Connect(function(child)
				if child.Name == "ErrorPrompt" then
					task.wait(0.1)
					local errorText = "Unknown Error"
					pcall(function()
						local msgArea = child:FindFirstChild("MessageArea")
						if msgArea then
							local errorFrame = msgArea:FindFirstChild("ErrorFrame")
							if errorFrame then
								local errorMessage = errorFrame:FindFirstChild("ErrorMessage")
								if errorMessage and errorMessage:IsA("TextLabel") then
									errorText = errorMessage.Text
								end
							end
						end
					end)
					if AFKTY and AFKTY.IsConnected and AFKTY:IsConnected() then
						pcall(function()
							AFKTY:Alert(errorText)
						end)
					end
				end
			end)
		end
	end
end)
